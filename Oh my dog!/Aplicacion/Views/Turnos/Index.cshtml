@model IEnumerable<Aplicacion.Models.Turnos>
@using Microsoft.AspNetCore.Identity;
@using System.Security.Claims;

@{
	ViewData["Title"] = "Index";
}
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="css/estiloCalendario.css">


@if (User.Identity.IsAuthenticated)
{

	<section class="ftco-section" id="seccion" data-usuario-mail="@User.FindFirstValue("email")">
		<div class="container">
			<div class="row ">
				<div class="col-xl-12 ">
					<div class="content w-100">
						<div class="calendar-container">
							<div class="calendar">
								<div class="year-header">
									<span class="left-button fa fa-chevron-left" id="prev"> </span>
									<span class="year" id="label"></span>
									<span class="right-button fa fa-chevron-right" id="next"> </span>
								</div>
								<table class="months-table w-100">
									<tbody>
										<tr class="months-row">
											<td class="month">Ene</td>
											<td class="month">Feb</td>
											<td class="month">Mar</td>
											<td class="month">Abr</td>
											<td class="month">May</td>
											<td class="month">Jun</td>
											<td class="month">Jul</td>
											<td class="month">Ago</td>
											<td class="month">Sep</td>
											<td class="month">Oct</td>
											<td class="month">Nov</td>
											<td class="month">Dic</td>
										</tr>
									</tbody>
								</table>

								<table class="days-table w-100">
									<td class="day">Dom</td>
									<td class="day">Lun</td>
									<td class="day">Mar</td>
									<td class="day">Mie</td>
									<td class="day">Jue</td>
									<td class="day">Vie</td>
									<td class="day">Sab</td>
								</table>
								<div class="frame">
									<table class="dates-table w-100">
										<tbody class="tbody">
										</tbody>
									</table>
								</div>
								@if (!User.IsInRole("Administrador"))
								{
									<button class="button d-none" disabled id="add-button">Solicitar turno</button>
								}
								else
								{<div class="d-flex justify-content-center">
									<button class="btn btn-success mb-3"  id="aceptados-button">Aceptados</button>
									<button class="btn btn-danger mx-2 mb-3"  id="rechazados-button">Rechazados</button>
									<button class="btn btn-warning mb-3" id="pendientes-button">Pendientes</button>
								</div>
								}

									
									</div>
							</div>
							<div class="events-container">
							</div>


							
		</section>
}
	
else
{
	<div class="container d-flex align-items-center justify-content-center">
		<h1>
			Para acceder a este sitio debe estar registrado.
		</h1>
		<img class="w-50 h-50" src="/img/PerroError.svg" />
	</div>
}

<!--Inicio Modal Ver detalle pendiente-->
<div class="modal fade" id="detallePendiente" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="staticBackdropLabel">
					<i class="fa-solid fa-user-plus fa-xl" style="color: #000000;"></i>
					Registrar nuevo cuidador
				</h1>
				<!--<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
			</div>
			<div class="modal-body">
				<form autocomplete="off" class="row g-3 needs-validation" novalidate id="formNuevoCliente">
					<div class="col-md-12">
						<label class="form-label">Email</label>
						<div class="input-group has-validation">
							<span class="input-group-text" id="inputGroupPrepend">@@</span>
							<input type="email" maxlength="50" class="form-control" id="nuevoEmail" aria-describedby="inputGroupPrepend" required>
							<div class="invalid-feedback">
								Ingrese un email válido (con @@)!
							</div>
						</div>
					</div>
					<div class="col-md-6">
						<label class="form-label">Nombre</label>
						<input type="text" maxlength="20" class="form-control" id="nuevoNombre" required>
						<div class="invalid-feedback">
							Ingrese un nombre!
						</div>
					</div>
					<div class="col-md-6">
						<label class="form-label">Apellido</label>
						<input type="text" maxlength="20" class="form-control" id="nuevoApellido" required>
						<div class="invalid-feedback">
							Ingresa un apellido!
						</div>
					</div>
					<div class="col-md-12">
						<label class="form-label">Ubicación</label>
						<input class="form-control" autocomplete="false" id="nuevoUbicacion" maxlength="300" required placeholder="Por ejemplo, calle 64 1544">
						<div class="invalid-feedback">
							Ingresa una dirección!
						</div>
					</div>
					<div class="col-md-12">
						<label class="form-label">Modalidad de trabajo</label> <br />
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="1" id="nuevoModalidad1" required>
							<label class="form-check-label" for="flexCheckDefault">
								Ir a domicilio
							</label>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="2" id="nuevoModalidad2" required>
							<label class="form-check-label" for="flexCheckChecked">
								En el hogar
							</label>
							<div class="invalid-feedback">
								Ingrese al menos una modalidad de trabajo!
							</div>
						</div>
					</div>
					<div class="col-md-6">
						<label class="form-label">Horario de comienzo</label>
						<input type="time" class="form-control" id="nuevoHorarioIN" required>
						<div class="invalid-feedback">
							Ingrese horas válidas (el horario de fin debe ser mayor al de comienzo)!
						</div>
					</div>
					<div class="col-md-6">
						<label class="form-label">Horario de fin</label>
						<input type="time" class="form-control" id="nuevoHorarioOUT" required>
					</div>
					<div class="col-md-12">
						<label class="form-label" for="nuevoUpload" value="">Foto (opcional)</label>
						<input type="file" class="form-control" accept=".jpg,.jpeg,.png" id="nuevoUpload" onchange="validateFileTypeNuevo()">
						<div class="invalid-feedback">
							La foto ingresada no es válida!
						</div>
					</div>
					<div style="display: none;">
						<input type="hidden" id="nuevaLatitud">
						<input type="hidden" id="nuevaLongitud">
					</div>
					<div class="modal-footer">
						@if (!User.IsInRole("Administrador"))
						{
							<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Ok</button>
						}
						else
						{
							<div class="d-flex justify-content-center">
								<button tpye="button" class="btn btn-success mb-3 activo" onclick="aceptarTurno()" id="aceptar-button" data-bs-dismiss="modal">Aceptar</button>
								<button tpye="button" class="btn btn-danger mx-2 mb-3" onclick="rechazarTurno()" id="rechazar-button" data-bs-dismiss="modal">Rechazar</button>
								
							</div>
						}
					</div>
				</form>
			</div>
		</div>
	</div>
</div>




<!--Inicio Modal Solicitar turno-->
<div class="modal fade" id="ModalDatosTurno" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="staticBackdropLabel">
					<i class="fa-solid fa-envelope fa-xl"></i>
					Solicitud de turno
				</h1>
				<!--<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
			</div>
			<div class="modal-body">
				<form autocomplete="off" class="row g-3 needs-validation" id="form-turnos" novalidate data-usuario-mail="@User.FindFirstValue("email")">

					<button type="button" class="btn btn-primary" onclick="agregarCamposMascota()">Agregar mascota</button>
					
					<div id="mascotas-dinamico">
						
					</div>

					



					<div class="col-md-12">
						<label for="destinatario" class="form-label">Franja horaria</label>
						<select id="horario">
							<option selected id="franjaMañana">Mañana (8 a 13 hs)</option>
							<option id="franjaTarde">Tarde (17 a 20 hs)</option>
						</select>
					</div>



					<div class="col-md-12">
						<label for="validationCustom01" class="form-label">Motivo</label>
						<input type="text" class="form-control" maxlength="50" id="motivo" name="motivo" required>
						<div class="invalid-feedback">
							Ingrese el motivo de su turno! (máximo 50 caracteres)
						</div>
					</div>

					<div class="modal-footer">

						
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancel-button">Cancelar</button>
						<button type="button" class="btn btn-primary" data-bs-dismiss="modal" disabled id="BtnTurno">Aceptar</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<!--Fin Modal Visualizar Paseador para contacto-->
@section Scripts{




	<!--Por cada mascota se da la opcion de seleccionar de entre sus mascotas o ingresar una nueva. Máximo 5 mascotas-->
	<script>
		var container = $("#mascotas-dinamico");
		function borrarCamposMascota(idBorrado){
			if ($(".mascota").length >1){
				// Obtener la última sección agregada
				var aBorrar = container.find("#mascota"+ idBorrado);
				// Remover la sección del contenedor
				
					var aDesocupar = $("#mascota" + idBorrado + " select option:selected").val();
					$("select[name=misMascotas]").find('option:contains("' + aDesocupar + '")').prop('disabled', false);
				
				
				aBorrar.remove();
				if ($(".mascota").length ==1){
				$("#borrarMascota").addClass("d-none");
				}
				cambiarValor();
				verificarFormulario();
				habilitarBotonEnvioContacto();
			}
		}
		
			function agregarCamposMascota() {
				// Obtener el contenedor donde se generará el bloque dinámico
			
			
				// Crear el elemento div principal
			var divElement = $("<div>").attr("id","mascota"+ ($(".mascota").length +1)).addClass("col-md-12 mascota");

				// Crear el elemento label
				var labelElement = $("<label>").attr("for", "misMascotas").addClass("form-label").text("Seleccione a su mascota");

				// Crear el elemento select
				var selectElement = $("<select>").attr("name", "misMascotas").prop("required", true);
				
				// Crear la opción "Otra" dentro del select
				var optionElement = $("<option>").addClass("otraMascota").text("Otra");
				selectElement.append(optionElement);

				// Crear el div para la opción "Otra"
				var otraDiv = $("<div>").addClass("d-none otra");

				// Crear el label para el input de nombre
				var nombreLabel = $("<label>").addClass("form-label").text("Nombre");

				// Crear el input de nombre
				var nombreInput = $("<input>").attr({ "type": "text", "maxlength": "20" }).addClass("form-control").prop("required", true);

				// Crear el div para el mensaje de error
				var invalidFeedbackDiv = $("<div>").addClass("invalid-feedback").text("Ingrese una mascota no registrada");

				// Agregar los elementos al div "otra"
				otraDiv.append(nombreLabel, nombreInput, invalidFeedbackDiv);

				// Agregar los elementos al div principal
			
			if ($(".mascota").length>0){
				var buttonEliminar = '<button type="button" id = "borrarMascota' + ($(".mascota").length + 1) + '"class="btn btn-danger" onclick = "borrarCamposMascota(' + ($(".mascota").length + 1) + ')" >Borrar</button>';
				divElement.append(labelElement, selectElement,buttonEliminar, otraDiv);
				}else{
				divElement.append(labelElement, selectElement, otraDiv);
				}
				// Agregar el div principal al contenedor
				container.append(divElement);

			$.each(mascotasUsuario, function (index, perro) {
				
				var nodoOpcion = $("<option class='otraMascota'>" + perro.Nombre + "</option>");
				var clonNodo = nodoOpcion.clone();
				$("#mascota" + $(".mascota").length + " select").prepend(clonNodo);
			});
			var nodoOpcion = $("<option class='otraMascota'>Seleccione una opcion</option>");
			var clonNodo = nodoOpcion.clone();
			$("#mascota" + $(".mascota").length + " select").prepend(clonNodo);
			for (i = 1; i <= $(".mascota").length; i++) {
				var aOcupar = $("#mascota" + i + " select option:selected").val();
				if (aOcupar != 'Otra') {
					$("select[name=misMascotas]").find('option:contains("' + aOcupar + '")').prop('disabled', true);
				}
			}
			$("#mascota" + ($(".mascota").length) + " select").prop("selectedIndex",0);
			$("#mascota" + ($(".mascota").length) + " select").find('option:contains("' + "Seleccione una opcion" + '")').prop('disabled', true);
			$("#mascota" + ($(".mascota").length) + " select").find('option:contains("' + "Seleccione una opcion" + '")').prop('hidden', true);
			cambiarValor();
			verificarFormulario();
			habilitarBotonEnvioContacto();
			}
			var asunto = document.getElementById('motivo');
			var enviarButtonContacto = document.getElementById('BtnTurno');
			//cambiar valor
			function habilitarBotonEnvioContacto() {
				var val = true;

			var todosValidos = $(".mascota select").toArray().every(function (select) {
				return $(select).hasClass("is-valid");
			});
				
				if (!(todosValidos)) {
						val = false;
					
					}
				
				if (asunto.classList.contains('is-valid') && val) {
					enviarButtonContacto.disabled = false;
				} else {
					enviarButtonContacto.disabled = true;
				}
			}




			var mascotasUsuario;
			function verificarFormulario() {
				asunto.addEventListener('input', validarAsunto);
				$("select[name=misMascotas]").on('input', function () {
					var valor = $(this).val();
					var esValido;
					var mascotaSeleccion = $(this);
					if (valor != 'Otra') {
						mascotaSeleccion.addClass('is-valid');
						mascotaSeleccion.removeClass('is-invalid');
						habilitarBotonEnvioContacto();
					}
					else {
						mascotaSeleccion.removeClass('is-valid');
						$(this).parent().find("div input").on('input', function () {
							var valorBuscar = $(this).val();
							var etiqueta = $(this);
							if (valorBuscar == '') {
								mascotaSeleccion.removeClass('is-valid');
								mascotaSeleccion.addClass('is-invalid');
								etiqueta.removeClass('is-valid');
								etiqueta.addClass('is-invalid');
								habilitarBotonEnvioContacto();
							}
							else {
								var encontre = false;
								$.each(mascotasUsuario, function (index, perro) {
									if (valorBuscar.toLowerCase() == perro.Nombre.toLowerCase()) {

										mascotaSeleccion.removeClass('is-valid');
										mascotaSeleccion.addClass('is-invalid');
										etiqueta.removeClass('is-valid');
										etiqueta.addClass('is-invalid');
										encontre = true;
										return false;
									}

								});
								if (!encontre) {
									mascotaSeleccion.removeClass('is-invalid');
									mascotaSeleccion.addClass('is-valid');
									etiqueta.removeClass('is-invalid');
									etiqueta.addClass('is-valid');
								}
								habilitarBotonEnvioContacto();
							}
						});
					}
				});



				function validarAsunto() {
					if (asunto.value.trim() !== '') {
						asunto.classList.remove('is-invalid');
						asunto.classList.add('is-valid');
					} else {
						asunto.classList.remove('is-valid');
						asunto.classList.add('is-invalid');
					}

					habilitarBotonEnvioContacto();
				}
				// Habilitar o deshabilitar el botón de envío según la validez del formulario
				

				$("#cancel-button").click(function () {
					var seleccion = $("#horario").prop("selectedIndex");
					document.getElementById('form-turnos').reset();
					$("#horario").prop("selectedIndex", seleccion);
				for (var i = $(".mascota").length; i >= 1; i--) {
						($("#mascota"+i).remove());
					}
					
					$("#dialog").hide(250);
				
					asunto.classList.remove('is-invalid'); asunto.classList.remove('is-valid');
					
					enviarButtonContacto.disabled = true;
				agregarCamposMascota();
					$(".events-container").show();
				});

			}
			var previous;
			function cambiarValor () {
			$("select[name='misMascotas']").on('focus', function () {
					previous = this.value;
				})
					.change(function () {
						var actual = this.value;
					$("select[name='misMascotas']").find('option:contains("' + previous + '")').prop('disabled', false);
						if (!(actual == "Otra")) {
							$(this).parent().find('div').addClass("d-none");
						$("select[name='misMascotas']").find('option:contains("' + actual + '")').prop('disabled', true);
						} else {
							$(this).parent().find('div').removeClass("d-none");
						}
						previous = this.value;
						habilitarBotonEnvioContacto();
					});
			};
			var emailUsuario = $("#form-turnos").data('usuario-mail'); // Obtener el valor del campo de entrada de 
			$.ajax({
				url: '@Url.Action("obtenerPerros", "Turnos")',
				type: 'GET',
				dataType: 'json',
				data: { mail: emailUsuario }, // Enviar los datos al controlador
				success: function (data) {
				mascotasUsuario=data.slice();	
				agregarCamposMascota();
				$("#add-button").prop("disabled",false);
				cambiarValor();
				verificarFormulario();
				habilitarBotonEnvioContacto();
				},
				error: function (xhr, status, error) {
					Swal.fire({
						icon: 'error',
						title: 'Oops...',
						text: 'Ocurrio un erorr!'
					})
				}
			});

	</script>

	<script>
		$(document).on('click', '#add-button', function () {
			
		//	Muestra la solicitud del turno
			$('#ModalDatosTurno').modal('show');
		});
		
		
	</script>


	<script>

		var event_data = {
			"events": [

			]
		};	
			 function cargar_eventos() {
				var emailUsuario = $("section").data('usuario-mail');
				$.ajax({
					url: '@Url.Action("obtenerEventos", "Turnos")',
					type: 'GET',
					async:false,
					dataType: 'json',
					data: { mail: emailUsuario }, // Enviar los datos al controlador
					success: function (data) {
						
						if (data.admin) {

							var turnosAsignados = JSON.parse(data.turnos);
							event_data["events"].push(true);
							$.each(turnosAsignados, function (index, turno) {
								event_data["events"].push(turno);
								
							})
							
						}
						else {
							var turnosAsignados = JSON.parse(data.turnos);
							event_data["events"].push(false);
							$.each(turnosAsignados, function (index, turno) {
								event_data["events"].push(turno);

							})
						}
					},
					error: function (xhr, status, error) {
						Swal.fire({
							icon: 'error',
							title: 'Oops...',
							text: 'Ocurrio un erorr!'
						})
					}
				});
				
			}



			"use strict";
			const meses = {
				"Ene": 0,
				"Feb": 1,
				"Mar": 2,
				"Abr": 3,
				"May": 4,
				"Jun": 5,
				"Jul": 6,
				"Ago": 7,
				"Sep": 8,
				"Oct": 9,
				"Nov": 10,
				"Dic": 11
			};
			// Setup the calendar with the current date
			$(document).ready( function () {
				var date = new Date();
				var today = date.getDate();
				cargar_eventos();
				// Set click handlers for DOM elements
				$(".right-button").click({ date: date }, next_year);
				$(".left-button").click({ date: date }, prev_year);
				$(".month").click({ date: date }, month_click);
				$("#add-button").click({ date: date }, new_event);
				// Set current month as active
				$(".months-row").children().eq(date.getMonth()).addClass("active-month");
				
				init_calendar(date);
				var events = chequear_events(today, date.getMonth() + 1, date.getFullYear());
				mostrar_eventos(events, date.getMonth() + 1, today);
				
			});
			




			var actual;
			function verificarFechas() {
				var date = new Date();
				actual = new Date(($("#label.year").html()), meses[($(".active-month").html())], parseInt($(".active-date").html()));
				$("#horario").prop("selectedIndex", 0);
				$("#franjaMañana").prop("disabled", false);
				$("#franjaTarde").prop("disabled", false);
				if (($("#label.year").html()) < date.getFullYear()) {
					$("#add-button").addClass("d-none");
					return;
				}
				if ((($("#label.year").html()) == date.getFullYear())
					&& (meses[($(".active-month").html())] < date.getMonth())) {
					$("#add-button").addClass("d-none");
					return;
				}

				if ((($("#label.year").html() == date.getFullYear())
					&& (meses[($(".active-month").html())] == date.getMonth()))
					&& (parseInt($(".active-date").html()) < date.getDate())) {
					$("#add-button").addClass("d-none");
					return;
				}

				if (actual.getDay() == 0) {
					$("#add-button").addClass("d-none");
					return;
				}

				if (actual.getDay() == 6 && date.getHours()>=8 && date.getDay() == 6) {
					$("#add-button").addClass("d-none");
					return;
				}else
					if (actual.getDay() == 6){

						$("#franjaTarde").prop("disabled", true);
					}
				

				if ((($("#label.year").html() == date.getFullYear())
					&& (meses[($(".active-month").html())] == date.getMonth()))
					&& (parseInt($(".active-date").html()) == date.getDate()) && (date.getHours() >=17)){
					$("#add-button").addClass("d-none");
					return;
				}

				if ((($("#label.year").html() == date.getFullYear())
					&& (meses[($(".active-month").html())] == date.getMonth()))
					&& (parseInt($(".active-date").html()) == date.getDate()) && (date.getHours()>=8)) {
					$("#franjaMañana").prop("disabled", true);
					$("#horario").prop("selectedIndex", 1);

				}
				$("#add-button").removeClass("d-none");
			}

		

			// Initialize the calendar by appending the HTML dates
		function init_calendar(date) {
			$(".tbody").empty();
			$(".events-container").empty();
			var calendar_days = $(".tbody");
			var month = date.getMonth();
			var year = date.getFullYear();
			var day_count = days_in_month(month, year);
			var row = $("<tr class='table-row'></tr>");
			var today = date.getDate();


			// Set date to 1 to find the first day of the month
			date.setDate(1);
			var first_day = date.getDay();
			// 35+firstDay is the number of date elements to be added to the dates table
			// 35 is from (7 days in a week) * (up to 5 rows of dates in a month)
			for (var i = 0; i < 35 + first_day; i++) {
				// Since some of the elements will be blank,
				// need to calculate actual date from index
				var day = i - first_day + 1;
				// If it is a sunday, make a new row
				if (i % 7 === 0) {

					calendar_days.append(row);
					row = $("<tr class='table-row'></tr>");
				}
				// if current index isn't a day in this month, make it blank
				if (i < first_day || day > day_count) {
					var curr_date = $("<td class='table-date nil'>" + "</td>");
					row.append(curr_date);
				}
				else {
					var curr_date = $("<td class='table-date'>" + day + "</td>");
					var events = chequear_events(day, month + 1, year);
					if (today === day && $(".active-date").length === 0) {
						curr_date.addClass("active-date");
						//show_events(events, months[month], day);
						mostrar_eventos(events, month + 1, day);
					}
					//Ver despuès
					// If this date has any events, style it with .event-date
					if (events.length > 1) {
						var color;
						if (events[0] == true) {
							if ($("#rechazados-button").hasClass("activa")) {
								if ((events.filter(i => i.Estado == 2).length) > 0) {
									color = "<div class='color-turno' style='background:#FF1744;'></div>";
									curr_date.append(color);
									curr_date.addClass("event-date");
								}
							} else {
								if ($("#aceptados-button").hasClass("activa")) {
									if ((events.filter(i => i.Estado == 1).length) > 0) {
										color = "<div class='color-turno' style='background:#6aa84f;'></div>";
										curr_date.append(color);
										curr_date.addClass("event-date");
									}
								}
								else {
									var valor = 0;
									if ($("#pendientes-button").hasClass("activa")) {
										

										if ((events.filter(i => i.Estado == 3).length) > 0) {
											color = "<div class='color-turno' style='background:#f1c232;'></div>";
											curr_date.append(color);
											curr_date.addClass("event-date");
											valor++;
										}
									}
									else{
										
										if ((valor == 0) && ((events.filter(i => i.Estado == 1).length) > 0)){
											color = "<div class='color-turno' style='background:#6aa84f;'></div>";
										curr_date.append(color);
										curr_date.addClass("event-date");
										valor++;
										}
										else if ((events.filter(i => i.Estado == 1).length) > 0){
											color = "<div class='color-turno2' style='background:#6aa84f;'></div>";
											curr_date.append(color);
											curr_date.addClass("event-date");
											valor++;
										}
										if ((valor == 0) && ((events.filter(i => i.Estado == 2).length) > 0)){
											color = "<div class='color-turno' style='background:#FF1744;'></div>";
										curr_date.append(color);
										curr_date.addClass("event-date");
										valor++;
										}
										else if ((valor == 1) && ((events.filter(i => i.Estado == 2).length) > 0)) {
											color = "<div class='color-turno2' style='background:#FF1744;'></div>";
											curr_date.append(color);
											curr_date.addClass("event-date");
											valor++;
										}else if ((valor == 2) && ((events.filter(i => i.Estado == 2).length) > 0)) {
											color = "<div class='color-turno3' style='background:#FF1744;'></div>";
											curr_date.append(color);
											curr_date.addClass("event-date");
											valor++;
										}
										
										
									}
								}
							}
						} else {
							if (events[1].Estado == 1) {
								color = "<div class='color-turno' style='background:#6aa84f;'></div>";
								curr_date.append(color);
								curr_date.addClass("event-date");
							}
							else if (events[1].Estado == 2) {
								color = "<div class='color-turno' style='background:#FF1744;'></div>";
								curr_date.append(color);
								curr_date.addClass("event-date");
							} else {
								color = "<div class='color-turno' style='background:#f1c232;'></div>";
								curr_date.append(color);
								curr_date.addClass("event-date");
							}
						}
					}
					

					// Set onClick handler for clicking a date
					curr_date.click({ events: events, month: month, day: day }, date_click);
					row.append(curr_date);
				}
			}
			// Append the last row and set the current year
			calendar_days.append(row);
			$(".year").text(year);
			verificarFechas();
		}

			// Get the number of days in a given month/year
			function days_in_month(month, year) {
				var monthStart = new Date(year, month, 1);
				var monthEnd = new Date(year, month + 1, 1);
				return (monthEnd - monthStart) / (1000 * 60 * 60 * 24);
			}

			// Event handler for when a date is clicked
			function date_click(event) {
				$(".events-container").show(250);
				$("#dialog").hide(250);
				$(".active-date").removeClass("active-date");
				$(this).addClass("active-date");
				verificarFechas();
				//_events(event.data.events, event.data.month, event.data.day);
				mostrar_eventos(event.data.events, event.data.month +1, event.data.day);
			};

			// Event handler for when a month is clicked
			function month_click(event) {
				$(".events-container").show(250);
				$("#dialog").hide(250);
				var date = event.data.date;
				$(".active-month").removeClass("active-month");
				$(this).addClass("active-month");
				var new_month = $(".month").index(this);
				date.setMonth(new_month);
				init_calendar(date);
			}

			// Event handler for when the year right-button is clicked
			function next_year(event) {
				$("#dialog").hide(250);
				var date = event.data.date;
				var new_year = date.getFullYear() + 1;
				$("year").html(new_year);
				date.setFullYear(new_year);
				init_calendar(date);
			}

			// Event handler for when the year left-button is clicked
			function prev_year(event) {
				$("#dialog").hide(250);
				var date = event.data.date;
				var new_year = date.getFullYear() - 1;
				$("year").html(new_year);
				date.setFullYear(new_year);
				init_calendar(date);
			}

			// Event handler for clicking the new event button
			function new_event(event) {
				// if a date isn't selected then do nothing
				if ($(".active-date").length === 0)
					return;
				// remove red error input on click
				// empty inputs and hide events
				$("#dialog input[type=text]").val('');
				$("#dialog input[type=number]").val('');
				$(".events-container").hide(0);
				$("#dialog").show(250);
				// Event handler for cancel button
				// Event handler for ok button
				$("#BtnTurno").unbind().click({ date: event.data.date }, function () {
					var date = event.data.date;
					var day = parseInt($(".active-date").html());
					$("#dialog").hide(250);
					console.log("new event");
					//Falta ajax. Hay que setear el turno para los que estàn registrados y agregar
					var nombrePerros = [];
					var valor = $("select[name=cantidadMascotas]").val();
					for (i = 1; i <= valor; i++) {
						var mascota = $("#mascota" + i + " select option:selected").val();
						if (mascota == 'Otra') {
							mascota = $("#mascota" + i + " div input").val();
						}
						nombrePerros.push(mascota);
					}

					var emailUsuario = $("#form-turnos").data('usuario-mail');
					var motive = document.getElementById('motivo').value;				
					var fechaIso = actual.toISOString();
					var horarioSel=$("#horario").prop("selectedIndex");
					
					$.ajax({
						url: '@Url.Action("cargarTurno", "Turnos")',
						type: 'POST',
						dataType: 'json',
						data: { mail: emailUsuario, fecha: fechaIso, perros: nombrePerros, motivo: motive,horario:horarioSel }, // Enviar los datos al controlador
						
						success: function (data) {
							var turno=JSON.parse(data.asignado);
							event_data["events"].push(turno);
						var seleccion = $("#horario").prop("selectedIndex");
						document.getElementById('form-turnos').reset();
						$("#horario").prop("selectedIndex", seleccion);
						for (var i = $(".mascota").length; i >= 1; i--) {
							($("#mascota" + i).remove());
						}
						
						$("#dialog").hide(250);
						
						asunto.classList.remove('is-invalid'); asunto.classList.remove('is-valid');
						enviarButtonContacto.disabled = true;
						agregarCamposMascota();
						$(".events-container").show();
						date.setDate(day);
						init_calendar(date);
							
							//new_event_json(name, count, date, day);
						},
						error: function (xhr, status, error) {
							Swal.fire({
								icon: 'error',
								title: 'Oops...',
								text: 'Ocurrio un erorr!'
							})
						}
					});

					
					

				});


			}
		


			// Given data for events in JSON format

			



			function chequear_events(day, month, year) {
				var events = [];
				var actual=new Date(year,month-1,day);
				
				
				var fechaIso=actual.toISOString();
				fechaIso=fechaIso.substr(0,10);
				events.push(event_data["events"][0]);
				
				for (var i = 1; i < event_data["events"].length; i++) {
					
					var event = event_data["events"][i];
					
					var fechaDb=(event.Fecha.substr(0,10));
					
					if (fechaDb==fechaIso) {
						events.push(event);
					
					}
				}
				return events;
			}



		function mostrarPendientes(events){
			var pendientes = (events.filter(i => i.Estado == 3));
			for (var i = 0; i < pendientes.length; i++) {
				var event_card = $("<div class='event-card'></div>");
				var event_name = $("<div class='event-name'>" + pendientes[i].Motivo + ":</div>");
				var event_count = $("<div class='event-count'>" + pendientes[i].Motivo + " Invited</div>");
				$(event_card).css({
					"border-left": "10px solid #f1c232"
				});
				event_count = $("<div class='event-cancelled'>Cancelado</div>");
				var event_button = $("<button class='btn btn-primary align-self-end'   onclick='verDetalle(" + pendientes[i].Id + ")' >Ver detalle</button>")
				$(event_card).append(event_name).append(event_count);
				$(event_card).append(event_button);
				$(".events-container").append(event_card);
			}
		}

		function mostrarRechazados(events){
			var rechazados = (events.filter(i => i.Estado == 2));
			for (var i = 0; i < rechazados.length; i++) {
				var event_card = $("<div class='event-card'></div>");
				var event_name = $("<div class='event-name'>" + rechazados[i].Motivo + ":</div>");
				var event_count = $("<div class='event-count'>" + rechazados[i].Motivo + " Invited</div>");
				$(event_card).css({
					"border-left": "10px solid #FF1744"
				});
				event_count = $("<div class='event-cancelled'>Cancelado</div>");
				var event_button = $("<button class='btn btn-primary align-self-end'   onclick='verDetalle(" + rechazados[i].Id + ")' >Ver detalle</button>")
				$(event_card).append(event_name).append(event_count);
				$(event_card).append(event_button);
				$(".events-container").append(event_card);
			}
		}

		function mostrarAceptados(events){
			var aceptados = (events.filter(i => i.Estado == 1));
			for (var i = 0; i < aceptados.length; i++) {
				var event_card = $("<div class='event-card'></div>");
				var event_name = $("<div class='event-name'>" + aceptados[i].Motivo + ":</div>");
				var event_count = $("<div class='event-count'>" + aceptados[i].Motivo + " Invited</div>");
				$(event_card).css({
					"border-left": "10px solid #6aa84f"
				});
				event_count = $("<div class='event-cancelled'>Cancelado</div>");
				var event_button = $("<button class='btn btn-primary align-self-end'   onclick='verDetalle(" + aceptados[i].Id + ")' >Ver detalle</button>")
				$(event_card).append(event_name).append(event_count);
				$(event_card).append(event_button);
				$(".events-container").append(event_card);
			}

		}

		function mostrar_eventos(events, month, day) {
			var evento;
			$(".events-container").empty();
			$(".events-container").show(250);

			if (events[0] == true) {


				if (((events.filter(m => m.Estado == 3).length == 0) && ($("#pendientes-button").hasClass("activa")))
					|| ((events.filter(m => m.Estado == 2).length == 0) && ($("#rechazados-button").hasClass("activa")))
					|| ((events.filter(m => m.Estado == 1).length == 0) && ($("#aceptados-button").hasClass("activa")))) {
					var event_card = $("<div class='event-card d-flex flex-column'></div>");
					var event_name = $("<div class='event-name mb-3'>No tiene turnos para el " + day + "/" + month + ".</div>");
					$(event_card).css({ "border-left": "10px solid #FF1744" });
					$(event_card).append(event_name);
					$(".events-container").append(event_card);
				}
				else {

					// Go through and add each event as a card to the events container


					if ($("#rechazados-button").hasClass("activa")) {
						mostrarRechazados(events);
					}
					else if ($("#aceptados-button").hasClass("activa")) {

						mostrarAceptados(events);
					} else if ($("#pendientes-button").hasClass("activa")) {
						mostrarPendientes();
					}else{
						mostrarPendientes(events);
						mostrarAceptados(events);
						mostrarRechazados(events);
						}
				}
			}
			else {

				if (events.length == 1) {

					var event_card = $("<div class='event-card d-flex flex-column'></div>");
					var event_name = $("<div class='event-name mb-3'>No tiene turnos para el " + day + " de " + month + ".</div>");
					$(event_card).css({ "border-left": "10px solid #FF1744" });

					$(event_card).append(event_name);

					$(".events-container").append(event_card);
				}
				else {

					// Go through and add each event as a card to the events container
					var event_card = $("<div class='event-card'></div>");

					var event_name = $("<div class='event-name'>" + events[1].Motivo + ":</div>");
					var event_count = $("<div class='event-count'>" + events[1].Motivo + " Invited</div>");
					if (events[1].Estado === 2) {
						$(event_card).css({
							"border-left": "10px solid #FF1744"
						});
						event_count = $("<div class='event-cancelled'>Cancelado</div>");
					} else {
						if (events[1].Estado == 1) {
							$(event_card).css({
								"border-left": "10px solid #6aa84f"
							});
							event_count = $("<div class='event-cancelled'>Aceptado</div>");
						} else {

							$(event_card).css({
								"border-left": "10px solid #f1c232"
							});
							event_count = $("<div class='event-cancelled'>Pendiente</div>");

						}
					}


					var event_button = $("<button class='btn btn-primary align-self-end' onclick='verDetalle(" + events[1].Id + ")' >Ver detalle</button>")
					$(event_card).append(event_name).append(event_count);
					$(event_card).append(event_button);
					$(".events-container").append(event_card);
				}
			}
		}


		

		function verDetalle(idTurno) {
			var turno=event_data["events"].filter(m=>m.Id==idTurno);
			
			if(turno[0].Estado==1){
				
				$("#detalleAceptado").modal("show");
			} else if (turno[0].Estado == 2){
				$("#detalleRechazado").modal("show");
			}
			else{
				$("#rechazar-button").attr("data-id-turno",idTurno);
				$("#aceptar-button").attr("data-id-turno", idTurno);
				$("#detallePendiente").modal("show");
			}
			
		}



		function rechazarTurno(){
			$(".events-container").empty();
			var idTurno=$("#rechazar-button").data("id-turno");
			var turno = event_data["events"].filter(m => m.Id == idTurno);
			turno[0].Estado=2;
			var index = event_data["events"].findIndex(el => el.Id === idTurno);
			
			event_data["events"][index]=turno[0];

			$.ajax({
				url: '@Url.Action("rechazarTurno", "Turnos")',
				type: 'POST',
				async: true,
				dataType: 'json',
				data: { idTurno: idTurno }, // Enviar los datos al controlador
				success: function (data) {
					$(".events-container").empty();
					var date = new date(turno[0].Fecha.substr(0, 10));
					var day = parseInt($(".active-date").html());
					date.setDate(day);
					init_calendar(date);
				},
				error: function (xhr, status, error) {
					Swal.fire({
						icon: 'error',
						title: 'Oops...',
						text: 'Ocurrio un erorr!'
					})
				}
			});
		}
		$("#aceptados-button").on('click',function(){
			if (!($("#aceptados-button").hasClass("activa")))
			{	$("#rechazados-button").removeClass("activa");
				$("#pendientes-button").removeClass("activa");
				$("#aceptados-button").addClass("activa");
				$(".events-container").empty();
				var fecha = new Date();
				fecha.setFullYear($("#label.year").html());
				fecha.setMonth(meses[($(".active-month").html())]);
				fecha.setDate(parseInt($(".active-date").html()));
				init_calendar(fecha);
			}

		});

		$("#rechazados-button").on('click', function () {
			if (!($("#rechazados-button").hasClass("activa"))) {
				$("#aceptados-button").removeClass("activa");
				$("#pendientes-button").removeClass("activa");
				$("#rechazados-button").addClass("activa");
				$(".events-container").empty();
				var fecha = new Date();
				fecha.setFullYear($("#label.year").html());
				fecha.setMonth(meses[($(".active-month").html())]);
				fecha.setDate(parseInt($(".active-date").html()));
				init_calendar(fecha);
			}

		});
		$("#pendientes-button").on('click', function () {
			if (!($("#pendientes-button").hasClass("activa"))) {
				$("#rechazados-button").removeClass("activa");
				$("#aceptados-button").removeClass("activa");
				$("#pendientes-button").addClass("activa");
				$(".events-container").empty();
				var fecha = new Date();
				fecha.setFullYear($("#label.year").html());
				fecha.setMonth(meses[($(".active-month").html())]);
				fecha.setDate(parseInt($(".active-date").html()));
				init_calendar(fecha);
			}

		});


		function aceptarTurno() {
			$(".events-container").empty();
				var idTurno = $("#aceptar-button").data("id-turno");
				
				var turno = event_data["events"].filter(m => m.Id == idTurno);
				turno[0].Estado = 1;
				var index = event_data["events"].findIndex(el => el.Id === idTurno);
				
				event_data["events"][index] = turno[0];
			$.ajax({
				url: '@Url.Action("aceptarTurno", "Turnos")',
				type: 'POST',
				async: true,
				dataType: 'json',
				data: { idTurno: idTurno }, // Enviar los datos al controlador
				success: function (data) {
					$(".events-container").empty();
					var date = new date(turno[0].Fecha.substr(0, 10));
					var day = parseInt($(".active-date").html());
					date.setDate(day);
					init_calendar(date);
				},
				error: function (xhr, status, error) {
					Swal.fire({
						icon: 'error',
						title: 'Oops...',
						text: 'Ocurrio un erorr!'
					})
				}
			});

		}


	</script>
}
